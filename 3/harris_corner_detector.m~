function [H, r, c] = harris_corner_detector(image)

sigma = 0.9;

I = rgb2gray(image);
I = double(I);
%I = imgaussfilt(I, sigma);

gauss_kernel = fspecial('gaussian', [3, 3], 0.6);
[Gx,Gy] = gradient(gauss_kernel);

%Gy = [1 0 -1; 2 0 -2; 1 0 -1];
%Gx = [1 2 1; 0 0 0; -1 -2 -1];

Ix = conv2(I, Gx);
Iy = conv2(I, Gy);

%figure, imshow(Ix);
%figure, imshow(Iy);
%drawnow

A = imgaussfilt(Ix .^ 2, sigma);
B = imgaussfilt(Ix .* Iy, sigma);
C = imgaussfilt(Iy .^ 2, sigma);

figure, imshow(uint8(A));
figure, imshow(uint8(B));
figure, imshow(uint8(C));
drawnow

H = (A .* C - B.^2 ) - 0.04 * (A + C).^2;

threshold = 230;

%corner_points = imregionalmax(H,8);
%corner_points = double(H) .* double(corner_points);

5
[h, w] = size(H);
window_size = 7;
offset = floor(window_size / 2)
corner_points = zeros(h, w);
padded_H = padarray(H, [offset, offset]);
for i = 1:h
    for j = 1:w
        i2 = i + window_size - 1;
        j2 = j + window_size - 1;
        
        corner_points(i, j) = sum(sum(padded_H(i:i2, j:j2) > H(i, j))) == 0;
        corner_points(i, j) = corner_points(i, j) * H(i, j);
    end 
end

figure, imshow(corner_points);

% normalize the points
corner_points = corner_points / max(max(corner_points));
figure, imshow(corner_points);


threshold = 0.8
[r, c] = find(corner_points > threshold);


figure, imshow(image);
hold on
plot(c, r, 'o');
hold off
drawnow


end






